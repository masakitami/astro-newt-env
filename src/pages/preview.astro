---
import Layout from '../layouts/Layout.astro';
import { getBlogs, getBlogDetail } from '../libs/microcms';

// ==================== 修正箇所 ここから ====================

// サーバーサイドレンダリングを有効にする
export const prerender = false;

let blogId;
let draftKey;
let blog;

// URLパラメータを取得
try {
  if (Astro.request.method === 'GET') {
    const url = new URL(Astro.request.url);
    const params = new URLSearchParams(url.search);
    blogId = params.get('blogId');
    draftKey = params.get('draftKey') || undefined;
  }
} catch (error) {
  console.error(error);
}

// ブログIDがない場合は404
if (!blogId) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}

// 記事の詳細情報を取得。取得できない場合は401を返す。
try {
  blog = await getBlogDetail(blogId as string, { draftKey: draftKey });
} catch {
  return new Response(null, {
    status: 401,
    statusText: 'Invalid Blog ID or Draft Key',
  });
}

// ==================== 修正箇所 ここまで ====================
---

<Layout title="My first blog with Astro">
  <main>
    <h1 class="title">{blog.title}</h1>
    <p class="publishedAt">公開日時：{blog.publishedAt}</p>
    <div class="post" set:html={blog.content} />
  </main>
</Layout>

<style>
  main {
    margin: auto;
    padding: 1em;
    max-width: 60ch;
  }
</style>
